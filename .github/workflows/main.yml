name: Run Gas Price Forecast

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  forecast:
    runs-on: ubuntu-24.04

    env:
      EIA_API_KEY: ${{ secrets.EIA_API_KEY }}

    steps:
      # Repository auschecken
      - name: Checkout repository
        uses: actions/checkout@v4

      # Python 3.10 installieren
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.10

      # Abhängigkeiten installieren
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # EIA Storage-Daten abrufen
      - name: Fetch EIA Storage
        run: |
          python fetch_eia_storage.py > eia_storage.txt 2> debug.log || echo "Fehler beim Abrufen"
          echo "----- DEBUG LOG -----"
          cat debug.log
          echo "----------------------"
          STORAGE=$(cat eia_storage.txt || echo 0)
          echo "EIA_STORAGE=$STORAGE" >> $GITHUB_ENV

      # US Production automatisch abrufen
      - name: Fetch US Production
        run: |
          python fetch_us_production.py > us_production.txt 2>/dev/null || echo "Fehler beim Abrufen"
          US_PROD=$(cat us_production.txt || echo 0)
          echo "US_PRODUCTION=$US_PROD" >> $GITHUB_ENV

      # LNG Feedgas automatisch abrufen (mit Fallback)
      - name: Fetch LNG Feedgas
        run: |
          if python fetch_lng_feedgas.py > lng_feedgas.txt 2>/dev/null; then
              LNG_FEEDGAS=$(cat lng_feedgas.txt)
          else
              echo "Fehler beim Abrufen, letzte verfügbare Meldung wird genutzt"
              LNG_FEEDGAS=$(cat lng_feedgas.txt || echo 0)
          fi
          echo "LNG_FEEDGAS=$LNG_FEEDGAS" >> $GITHUB_ENV

      # Gaspreis-Forecast Skript ausführen
      - name: Run Gas Price Forecast
        run: |
          python gas_price_forecast.py \
            --eia-storage $EIA_STORAGE \
            --us-production $US_PRODUCTION \
            --lng-feedgas $LNG_FEEDGAS \
            --futures-curve 0 \
            --cot-managed-money 0
